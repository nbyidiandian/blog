首先声明：盗取他人私钥是一种不道德的行为。但是呢，既然使用正常手段拿到私钥，就只能算借用了 :) <br>

另外，不得不提个人操作线上机器的一点原则：公用帐号（admin）是公共环境，不随意修改公共环境的任何内容，不在公共环境遗留个人文件，不在公共环境启daemon进程。否则与公共环境随意大小便无异。<br>

在坚持以上原则的前提下，我遇到了两个个人觉得比较烦人的问题：<br>
第一点是登陆线上机器过程比较复杂。需要先登陆跳板机，从跳板机ssh到audi5.cm6的个人帐户，然后在audi5.cm6上sudo切换到admin，最后再从audi5.cm6的admin帐户ssh到生产机。这个过程实在是相当的烦人。<br>
当然你肯定要说，用secureCRT啊，写个脚本就都搞定了，但是我对这个界面复杂、奇丑无比的东西实在是非常反感。<br>
为了把这个过程变得稍微简单一些，我在跳板机个人帐户下的.bashrc里加上了一条"ssh audi5.cm6"，这样每次登陆到跳板机时就自动ssh到audi5.cm6了。然后在audi5.cm6的个人帐户下开一个screen，大部分问题就都解决了。<br>
但是，由于audi5.cm6的screen是开在个人帐户下的，每次新开一个screen的tab要ssh到另外一台机器上时，还是不得不再sudo切换admin，再ssh。仍然很烦。<br>

第二点是我在audi5.cm6启了一个http server，这里有一堆我自己的cgi脚本，这些脚本有的时候需要ssh到某一台生产环境机器admin帐户获取一些数据，有的时候又需要ssh到另外一台机器jianhao帐户获取另外一些数据。这时我遇到麻烦了：我是在个人帐户下，怎么ssh到生产环境的admin呢？我并不知道admin帐户的密码！无解。。。<br>


为了解决上面这两个问题，不得不先学习下密钥。尽管大家都知道可以在linux下用ssh-kengen生成密钥，也知道怎么让其它机器接受我的密钥让我不用输密码也能ssh。但是却未必能弄清楚公钥与私钥到底是什么关系。当然，我其实也不了解，只是我想把我简单的理解告诉大家：<br>
私钥是我个人的，对其它任何人都是保密的，所以我们的私钥一般需要设置权限为700，否则系统会不认可你的私钥。私钥默认名字为id_rsa或id_dsa。<br>
每一个私钥都会对应一个公钥，通常在id_rsa.pub或id_dsa.pub里。这个文件的内容只是用来给人看的，系统基本不会用到它。公钥是公开的，供别人使用的。如果有人想要接受你的私钥，授予你权限登陆他的帐户，那么他就需要把你的公钥加到他的authorized_keys里。告诉系统说，这个公钥对应的私钥被授权了，他可以登陆我的帐户。<br>
所以，通常我们需要打通两台机器的免密码ssh通道时，通常需要先生成自己的私钥和公钥（当然如果你已经有了自己常用的密钥，就不用再重新生成了，直接copy一份就可以）。然后把公钥内容append到ssh目标机器的authorized_keys里。在权限设置正确后，就可以随意ssh了<br>
补充一句：RSA和DSA只是两种不同的加密算法，你可以随意选择一种。<br>


弄清楚了密钥之后，我们要来解决前面提到的问题了：怎么在我的jianhao帐户下既能ssh到另外一台机器的admin帐户，还能ssh到另外一台机器的jianhao帐户。而且是在脚本里，还不知道admin帐户的密码！（我个人所有机器的个人帐户之间密钥都统一的，所以可以随意ssh）。先看看下面我的配置吧：
<syntaxhighlight lang="cpp" line="GESHI_NORMAL_LINE_NUMBERS|GESHI_FANCY_LINE_NUMBERS">
Host=hadoop
Hostname=s002163.cm6
User=jianhao

Host=*
User=admin
StrictHostKeyChecking=no
IdentityFile=/home/jianhao/.ssh/id_dsa_admin
</syntaxhighlight>
这是我在audi5.cm6的个人帐户下的ssh_config。<br>
s002163.cm6这是云梯的gateway，这里使用的是我的个人帐号。<br>
最关键的是第二组配置，解释下这些配置：
* Host=*代表所有的机器
* User=admin代表ssh时默认使用admin帐户登陆所有机器
* StrictHostKeyChecking=no 加上这个配置后ssh就再也不会输出那段烦人的提示了
* IdentityFile，这是免sudo、免输入密码登陆所有线上生产机的核心。这里盗用了生产机admin帐户的私钥。

在我个人帐户的$HOME/.ssh/config里加上这些配置后，要登陆生产机的admin帐户，就再也不需要sudo到admin，也不需要输入密码了。
这里我维护了两份私钥，一个是我自己的私钥，登陆其它机器的个人帐户时使用我自己的私钥，比如s002163.cm6。
而其它所有的机器，由于大都没有我的个人帐号，所以我就只能盗用admin帐户的私钥了。
